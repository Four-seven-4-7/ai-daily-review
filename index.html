<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://cdn.staticfile.net">
    <title>æ¯æ—¥ç»“æ„åŒ–å¤ç›˜</title>
    <!-- æ ¸å¿ƒåº“ (å…¨éƒ¨ä½¿ç”¨å›½å†…é«˜é€Ÿé•œåƒ) -->
    <script src="https://cdn.staticfile.net/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.staticfile.net/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.staticfile.net/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.staticfile.net/dayjs/1.11.10/dayjs.min.js"></script>
    <link rel="stylesheet" href="https://cdn.staticfile.net/antd/5.14.0/reset.min.css">
    <script src="https://cdn.staticfile.net/antd/5.14.0/antd.min.js"></script>
    <script src="https://cdn.staticfile.net/ant-design-icons/5.2.6/index.umd.min.js"></script>
    <script src="https://cdn.staticfile.net/supabase/2.39.3/supabase.min.js"></script>
    
    <style>
        body { background-color: #fffbe6; padding: 20px; margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        .skeleton-loader { max-width: 800px; margin: 0 auto; padding: 24px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .skeleton-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .skeleton-title { width: 200px; height: 32px; background: #f0f0f0; border-radius: 4px; }
        .skeleton-btn { width: 80px; height: 32px; background: #f0f0f0; border-radius: 4px; }
        .skeleton-block { height: 120px; background: #f5f5f5; margin-bottom: 20px; border-radius: 8px; }
        .skeleton-line { height: 40px; background: #f5f5f5; margin-bottom: 15px; border-radius: 4px; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        .skeleton-loader * { animation: pulse 1.5s ease-in-out infinite; }
        #root:empty { display: none; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .section-title { margin-top: 24px; margin-bottom: 16px; font-weight: bold; font-size: 16px; border-left: 4px solid #fa8c16; padding-left: 8px; color: #595959; }
        .plan-item { display: flex; align-items: flex-start; margin-bottom: 8px; gap: 8px; }
        .plan-item .ant-checkbox-wrapper { margin-top: 5px; }
        .history-item:hover { background-color: #fff7e6; transition: background-color 0.3s; cursor: pointer; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <div class="skeleton-loader" id="static-skeleton">
        <div class="skeleton-header">
            <div class="skeleton-title"></div>
            <div style="display:flex; gap:10px"><div class="skeleton-btn"></div><div class="skeleton-btn"></div></div>
        </div>
        <div class="skeleton-line" style="width: 150px;"></div>
        <div class="skeleton-block"></div>
        <div class="skeleton-line" style="width: 200px;"></div>
        <div class="skeleton-block"></div>
    </div>

    <script type="text/babel">
        // ç´§æ€¥çº é”™ï¼šç¡®ä¿å›¾æ ‡åº“æ­£ç¡®åŠ è½½
        const Icons = window.icons || {};
        const { SettingOutlined, HistoryOutlined, ExportOutlined, PlusOutlined, DeleteOutlined, CheckCircleOutlined, LeftOutlined, RightOutlined, CloudDownloadOutlined } = Icons;

        const { useState, useEffect, useMemo, useRef } = React;
        const { Button, Input, Checkbox, Select, message, Typography, Card, Empty, Modal, List, Tag, DatePicker, Progress, Space, Spin } = antd;
        const { Title, Text } = Typography;
        const { TextArea } = Input;

        const SUPABASE_URL = 'https://usytwmlxzyzryzwwfzig.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzeXR3bWx4enl6cnl6d3dmemlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2OTAyNjQsImV4cCI6MjA4NTI2NjI2NH0.ZIqSJZN91Ncu5FGCp4kwHjrOR-2hWeGjVtPiBsTWqCY';
        const STORAGE_KEY_PREFIX = 'daily_review_';

        const getDeviceId = () => {
            let id = localStorage.getItem('daily_review_device_id');
            if (!id) {
                id = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                localStorage.setItem('daily_review_device_id', id);
            }
            return id;
        };

        const supabaseService = {
            async saveReview(date, data) {
                try {
                    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    return await client.from('daily_reviews').upsert({ 
                        date, 
                        user_id: getDeviceId(), 
                        content: data, 
                        updated_at: new Date().toISOString() 
                    }, { onConflict: 'date,user_id' });
                } catch(e) { return { error: e }; }
            },
            async getReview(date) {
                try {
                    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    const { data, error } = await client.from('daily_reviews').select('*').eq('date', date).eq('user_id', getDeviceId()).maybeSingle();
                    return { data: data?.content, error };
                } catch(e) { return { error: e }; }
            }
        };

        const PlanList = ({ title, items, onChange, isTomorrow = false }) => (
            <div>
                <div className="section-title">{title}</div>
                {items.map(item => (
                    <div key={item.id} className="plan-item">
                        {!isTomorrow && <Checkbox checked={item.done} onChange={e => onChange(items.map(i => i.id === item.id ? {...i, done: e.target.checked} : i))} />}
                        <Input value={item.text} placeholder="äº‹é¡¹å†…å®¹" onChange={e => onChange(items.map(i => i.id === item.id ? {...i, text: e.target.value} : i))} />
                        {isTomorrow && <Button type="text" danger onClick={() => onChange(items.filter(i => i.id !== item.id))} icon={<DeleteOutlined />} />}
                    </div>
                ))}
                {isTomorrow && <Button type="dashed" block onClick={() => onChange([...items, {id: Date.now().toString(), text: '', done: false}])} icon={<PlusOutlined />}>æ·»åŠ è®¡åˆ’</Button>}
                {!isTomorrow && items.length === 0 && <Empty description="ä»Šæ—¥æš‚æ— è®¡åˆ’" image={Empty.PRESENTED_IMAGE_SIMPLE} />}
            </div>
        );

        const App = () => {
            const [loading, setLoading] = useState(true);
            const [currentDate, setCurrentDate] = useState(dayjs().format('YYYY-MM-DD'));
            const [todayPlans, setTodayPlans] = useState([]);
            const [tomorrowPlans, setTomorrowPlans] = useState([]);
            const [mainTheme, setMainTheme] = useState('');

            useEffect(() => {
                const skeleton = document.getElementById('static-skeleton');
                if (skeleton) skeleton.style.display = 'none';
                setLoading(false);
                loadLocalData(currentDate);
            }, [currentDate]);

            const loadLocalData = (date) => {
                const saved = localStorage.getItem(STORAGE_KEY_PREFIX + date);
                if (saved) {
                    const d = JSON.parse(saved);
                    setTodayPlans(d.todayPlans || []);
                    setTomorrowPlans(d.tomorrowPlans || []);
                    setMainTheme(d.mainTheme || '');
                } else {
                    setTodayPlans([]); setTomorrowPlans([]); setMainTheme('');
                }
            };

            const handleSave = async () => {
                const data = { todayPlans, tomorrowPlans, mainTheme, date: currentDate };
                localStorage.setItem(STORAGE_KEY_PREFIX + currentDate, JSON.stringify(data));
                message.loading({ content: 'åŒæ­¥ä¸­...', key: 'save' });
                const { error } = await supabaseService.saveReview(currentDate, data);
                if (error) message.warning({ content: 'æœ¬åœ°å·²å­˜ï¼Œäº‘ç«¯åŒæ­¥å¤±è´¥', key: 'save' });
                else message.success({ content: 'å·²åŒæ­¥è‡³äº‘ç«¯', key: 'save' });
            };

            const handlePull = async () => {
                message.loading({ content: 'è·å–ä¸­...', key: 'pull' });
                const { data, error } = await supabaseService.getReview(currentDate);
                if (error) message.error({ content: 'è·å–å¤±è´¥', key: 'pull' });
                else if (!data) message.info({ content: 'äº‘ç«¯æš‚æ— æ•°æ®', key: 'pull' });
                else {
                    setTodayPlans(data.todayPlans || []);
                    setTomorrowPlans(data.tomorrowPlans || []);
                    setMainTheme(data.mainTheme || '');
                    message.success({ content: 'å·²åŒæ­¥äº‘ç«¯æ•°æ®', key: 'pull' });
                }
            };

            return (
                <div className="container">
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 }}>
                        <Title level={3} style={{ margin: 0 }}>ğŸ“… æ¯æ—¥ç»“æ„åŒ–å¤ç›˜</Title>
                        <Space>
                            <Button icon={<CloudDownloadOutlined />} onClick={handlePull}>æ‹‰å–</Button>
                            <Button icon={<ExportOutlined />} onClick={() => message.info('åŠŸèƒ½å¼€å‘ä¸­')}>å¯¼å‡º</Button>
                        </Space>
                    </div>

                    <div style={{ background: '#fff7e6', padding: 16, borderRadius: 8, marginBottom: 20, display: 'flex', gap: 10, alignItems: 'center' }}>
                        <Button icon={<LeftOutlined />} onClick={() => setCurrentDate(dayjs(currentDate).subtract(1, 'day').format('YYYY-MM-DD'))} />
                        <DatePicker value={dayjs(currentDate)} onChange={d => setCurrentDate(d.format('YYYY-MM-DD'))} allowClear={false} style={{ flex: 1 }} />
                        <Button icon={<RightOutlined />} onClick={() => setCurrentDate(dayjs(currentDate).add(1, 'day').format('YYYY-MM-DD'))} />
                    </div>

                    <PlanList title="1. ä»Šæ—¥è®¡åˆ’å®Œæˆæƒ…å†µ" items={todayPlans} onChange={setTodayPlans} />
                    <PlanList title="2. æ˜æ—¥è®¡åˆ’äº‹é¡¹" items={tomorrowPlans} onChange={setTomorrowPlans} isTomorrow />
                    
                    <div className="section-title">3. ä¸»é¢˜è§‰å¯Ÿ</div>
                    <TextArea rows={4} placeholder="å†™ä¸‹ä»Šå¤©çš„æ„Ÿæ‚Ÿ..." value={mainTheme} onChange={e => setMainTheme(e.target.value)} />

                    <Button type="primary" block size="large" onClick={handleSave} style={{ marginTop: 24, height: 50, fontSize: 18 }} icon={<CheckCircleOutlined />}>
                        æ äº¤ å¤ ç›˜
                    </Button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <antd.ConfigProvider theme={{ token: { colorPrimary: '#fa8c16' } }}>
                <App />
            </antd.ConfigProvider>
        );
    </script>
</body>
</html>