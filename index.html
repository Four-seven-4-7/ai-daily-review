<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://cdn.staticfile.net">
    <title>æ¯æ—¥ç»“æ„åŒ–å¤ç›˜</title>
    <!-- React & ReactDOM -->
    <script src="https://cdn.staticfile.net/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.staticfile.net/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://cdn.staticfile.net/babel-standalone/7.23.5/babel.min.js"></script>
    <!-- Day.js -->
    <script src="https://cdn.staticfile.net/dayjs/1.11.10/dayjs.min.js"></script>
    <!-- Ant Design -->
    <link rel="stylesheet" href="https://cdn.staticfile.net/antd/5.14.0/reset.min.css">
    <script src="https://cdn.staticfile.net/antd/5.14.0/antd.min.js"></script>
    <script src="https://cdn.staticfile.net/ant-design-icons/5.2.6/index.umd.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.staticfile.net/supabase/2.39.3/supabase.min.js"></script>
    
    <style>
        body { background-color: #fffbe6; padding: 20px; margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        .skeleton-loader { max-width: 800px; margin: 0 auto; padding: 24px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .skeleton-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .skeleton-title { width: 200px; height: 32px; background: #f0f0f0; border-radius: 4px; }
        .skeleton-btn { width: 80px; height: 32px; background: #f0f0f0; border-radius: 4px; }
        .skeleton-block { height: 120px; background: #f5f5f5; margin-bottom: 20px; border-radius: 8px; }
        .skeleton-line { height: 40px; background: #f5f5f5; margin-bottom: 15px; border-radius: 4px; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        .skeleton-loader * { animation: pulse 1.5s ease-in-out infinite; }
        #root:empty { display: none; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .section-title { margin-top: 24px; margin-bottom: 16px; font-weight: bold; font-size: 16px; border-left: 4px solid #fa8c16; padding-left: 8px; color: #595959; }
        .plan-item { display: flex; align-items: flex-start; margin-bottom: 8px; gap: 8px; }
        .plan-item .ant-checkbox-wrapper { margin-top: 5px; }
        .history-item:hover { background-color: #fff7e6; transition: background-color 0.3s; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <div class="skeleton-loader" id="static-skeleton">
        <div class="skeleton-header">
            <div class="skeleton-title"></div>
            <div style="display:flex; gap:10px"><div class="skeleton-btn"></div><div class="skeleton-btn"></div></div>
        </div>
        <div class="skeleton-line" style="width: 150px;"></div>
        <div class="skeleton-block"></div>
        <div class="skeleton-line" style="width: 200px;"></div>
        <div class="skeleton-block"></div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { Button, Input, Checkbox, Select, message, Typography, Card, Empty, Modal, List, Tag, DatePicker, Progress, Space, Spin } = antd;
        const { Title, Text } = Typography;
        const { TextArea } = Input;
        const { SettingOutlined, HistoryOutlined, ExportOutlined, PlusOutlined, DeleteOutlined, CheckCircleOutlined, LeftOutlined, RightOutlined, CloudDownloadOutlined } = icons;

        const SUPABASE_URL = 'https://usytwmlxzyzryzwwfzig.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzeXR3bWx4enl6cnl6d3dmemlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2OTAyNjQsImV4cCI6MjA4NTI2NjI2NH0.ZIqSJZN91Ncu5FGCp4kwHjrOR-2hWeGjVtPiBsTWqCY';
        const STORAGE_KEY_PREFIX = 'daily_review_';

        const getDeviceId = () => {
            let id = localStorage.getItem('daily_review_device_id');
            if (!id) {
                id = crypto.randomUUID();
                localStorage.setItem('daily_review_device_id', id);
            }
            return id;
        };

        const supabaseService = {
            async saveReview(date, data) {
                const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                return await client.from('daily_reviews').upsert({ date, user_id: getDeviceId(), content: data, updated_at: new Date().toISOString() }, { onConflict: 'date,user_id' });
            },
            async getReview(date) {
                const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                const { data, error } = await client.from('daily_reviews').select('*').eq('date', date).eq('user_id', getDeviceId()).maybeSingle();
                return { data: data?.content, error };
            },
            async getAllReviews() {
                const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                const { data, error } = await client.from('daily_reviews').select('*').eq('user_id', getDeviceId()).order('date', { ascending: false });
                return { data: data?.map(d => d.content), error };
            }
        };

        const PlanList = ({ title, items, onChange, isTomorrow = false }) => (
            <div>
                <div className="section-title">{title}</div>
                {items.map(item => (
                    <div key={item.id} className="plan-item">
                        {!isTomorrow && <Checkbox checked={item.done} onChange={e => onChange(items.map(i => i.id === item.id ? {...i, done: e.target.checked} : i))} />}
                        <Input value={item.text} placeholder="äº‹é¡¹å†…å®¹" onChange={e => onChange(items.map(i => i.id === item.id ? {...i, text: e.target.value} : i))} />
                        {isTomorrow && <Button type="text" danger onClick={() => onChange(items.filter(i => i.id !== item.id))}>åˆ é™¤</Button>}
                    </div>
                ))}
                {isTomorrow && <Button type="dashed" block onClick={() => onChange([...items, {id: Date.now().toString(), text: '', done: false}])}>+ æ·»åŠ </Button>}
            </div>
        );

        const App = () => {
            const [loading, setLoading] = useState(true);
            const [currentDate, setCurrentDate] = useState(dayjs().format('YYYY-MM-DD'));
            const [todayPlans, setTodayPlans] = useState([]);
            const [tomorrowPlans, setTomorrowPlans] = useState([]);
            const [mainTheme, setMainTheme] = useState('');

            useEffect(() => {
                const skeleton = document.getElementById('static-skeleton');
                if (skeleton) skeleton.style.display = 'none';
                setLoading(false);
            }, []);

            const handleSave = async () => {
                const data = { todayPlans, tomorrowPlans, mainTheme, date: currentDate };
                localStorage.setItem(STORAGE_KEY_PREFIX + currentDate, JSON.stringify(data));
                const { error } = await supabaseService.saveReview(currentDate, data);
                if (error) message.error('åŒæ­¥å¤±è´¥'); else message.success('å·²åŒæ­¥');
            };

            return (
                <div className="container">
                    <Title level={3}>ğŸ“… æ¯æ—¥ç»“æ„åŒ–å¤ç›˜</Title>
                    <div style={{ marginBottom: 20, display: 'flex', gap: 10 }}>
                        <DatePicker value={dayjs(currentDate)} onChange={d => setCurrentDate(d.format('YYYY-MM-DD'))} allowClear={false} />
                        <Button onClick={() => {
                            const saved = localStorage.getItem(STORAGE_KEY_PREFIX + currentDate);
                            if (saved) { const d = JSON.parse(saved); setTodayPlans(d.todayPlans); setTomorrowPlans(d.tomorrowPlans); setMainTheme(d.mainTheme); }
                        }}>åŠ è½½æœ¬åœ°</Button>
                    </div>
                    <PlanList title="ä»Šæ—¥è®¡åˆ’" items={todayPlans} onChange={setTodayPlans} />
                    <PlanList title="æ˜æ—¥è®¡åˆ’" items={tomorrowPlans} onChange={setTomorrowPlans} isTomorrow />
                    <div className="section-title">ä¸»é¢˜è§‰å¯Ÿ</div>
                    <TextArea rows={4} value={mainTheme} onChange={e => setMainTheme(e.target.value)} />
                    <Button type="primary" block size="large" onClick={handleSave} style={{ marginTop: 20 }}>æäº¤å¤ç›˜</Button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>